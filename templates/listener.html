{% block extra_scripts %}
<script>
let listenerActive = false;
let pollInterval = null;

document.getElementById('listenerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusSection = document.getElementById('statusSection');
    const resultSection = document.getElementById('resultSection');
    
    // Disable form and show status
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="bi bi-gear-fill"></i> Starting...';
    statusSection.style.display = 'block';
    resultSection.style.display = 'none';
    
    try {
        const data = {
            host: document.getElementById('hostAddress').value,
            port: document.getElementById('hostPort').value
        };
        
        // Update config display
        document.getElementById('configHost').textContent = data.host;
        document.getElementById('configPort').textContent = data.port;
        
        const response = await fetch('/start_listener', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            listenerActive = true;
            
            // Update UI
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            
            // Show success message (fixed: use .message)
            resultSection.style.display = 'block';
            document.getElementById('resultCard').className = 'card bg-success';
            document.getElementById('resultText').textContent = result.message || 'Listener started successfully';
            
            // Start polling for status/connections
            pollInterval = setInterval(pollListenerStatus, 5000);
        } else {
            throw new Error(result.error || result.message || 'Failed to start listener');
        }
        
    } catch (error) {
        console.error('Listener start error:', error);  // Debug log
        statusSection.style.display = 'none';
        resultSection.style.display = 'block';
        document.getElementById('resultCard').className = 'card bg-danger';
        document.getElementById('resultText').textContent = error.message || 'An unexpected error occurred';
        
        // Reset button
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="bi bi-ear"></i> Start Listener';
    }
});

document.getElementById('stopBtn').addEventListener('click', async function() {
    if (listenerActive) {
        try {
            const data = {
                host: document.getElementById('hostAddress').value,
                port: document.getElementById('hostPort').value
            };
            
            await fetch('/stop_listener', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
        } catch (error) {
            console.error('Stop error:', error);
        }
        
        listenerActive = false;
        
        // Stop polling
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
        
        // Reset UI
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('startBtn').disabled = false;
        document.getElementById('startBtn').innerHTML = '<i class="bi bi-ear"></i> Start Listener';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('statusSection').style.display = 'none';
        
        // Show stopped message
        document.getElementById('resultSection').style.display = 'block';
        document.getElementById('resultCard').className = 'card bg-warning';
        document.getElementById('resultText').textContent = 'Listener stopped. Note: Metasploit console may still be running in the background.';
    }
});

// Polling function for listener status
async function pollListenerStatus() {
    try {
        const host = document.getElementById('configHost').textContent;
        const port = document.getElementById('configPort').textContent;
        const response = await fetch(`/status/listener?host=${host}&port=${port}`);
        const data = await response.json();
        
        if (data.connections !== undefined) {
            document.getElementById('connectionsText').textContent = `Connections: ${data.connections}`;
            if (data.connections > 0) {
                document.getElementById('statusText').textContent = data.message || 'Active connections detected!';
                document.getElementById('statusText').className = 'text-warning';
            }
        }
    } catch (error) {
        console.error('Polling error:', error);
    }
}

// Get current IP address for convenience
async function getCurrentIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        return null;
    }
}

// Auto-fill public IP option
window.addEventListener('load', async function() {
    const publicIP = await getCurrentIP();
    if (publicIP) {
        const hostInput = document.getElementById('hostAddress');
        hostInput.placeholder = `127.0.0.1 (or ${publicIP} for remote access)`;
    }
});
</script>
{% endblock %}